<!-- User Menu Container -->
<div class="user-menu-container relative" *ngIf="user() as currentUser">
  
  <!-- User Menu Trigger Button -->
  <button 
    (click)="toggleMenu()"
    class="user-menu-trigger flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 hover:shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
    [class.active]="isMenuOpen()"
    aria-expanded="isMenuOpen()"
    aria-haspopup="true">
    
    <!-- User Avatar -->
    <div class="user-avatar relative">
      <img 
        *ngIf="currentUser.avatarUrl" 
        [src]="currentUser.avatarUrl" 
        [alt]="currentUser.displayName"
        class="w-9 h-9 rounded-full object-cover ring-2 ring-gray-200 hover:ring-blue-300 transition-all duration-200">
      
      <div 
        *ngIf="!currentUser.avatarUrl" 
        class="w-9 h-9 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center ring-2 ring-gray-200 hover:ring-blue-300 transition-all duration-200 shadow-sm">
        <span class="text-white font-semibold text-sm">{{ userInitials() }}</span>
      </div>
      
      <!-- Online Status Indicator -->
      <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white shadow-sm"></div>
    </div>

    <!-- User Info (Hidden on small screens) -->
    <div class="user-info hidden sm:block text-left">
      <p class="font-medium text-gray-900 text-sm leading-tight">{{ currentUser.displayName }}</p>
      <p class="text-xs text-gray-500 leading-tight">{{ userRole() }}</p>
    </div>

    <!-- Dropdown Arrow -->
    <div class="dropdown-arrow hidden sm:block">
      <i class="pi pi-chevron-down text-xs text-gray-400 transition-transform duration-200"
         [class.rotate-180]="isMenuOpen()"></i>
    </div>
  </button>

  <!-- Dropdown Menu -->
  <div 
    *ngIf="isMenuOpen()"
    class="user-dropdown absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50 animate-dropdown-enter"
    role="menu"
    aria-orientation="vertical">
    
    <!-- User Header in Dropdown -->
    <div class="px-4 py-3 border-b border-gray-100">
      <div class="flex items-center space-x-3">
        <!-- Avatar -->
        <div class="flex-shrink-0">
          <img 
            *ngIf="currentUser.avatarUrl" 
            [src]="currentUser.avatarUrl" 
            [alt]="currentUser.displayName"
            class="w-10 h-10 rounded-full object-cover">
          
          <div 
            *ngIf="!currentUser.avatarUrl" 
            class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center">
            <span class="text-white font-semibold text-sm">{{ userInitials() }}</span>
          </div>
        </div>
        
        <!-- User Details -->
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-900 text-sm truncate">{{ currentUser.displayName }}</p>
          <p class="text-xs text-gray-500 truncate">{{ currentUser.email }}</p>
          <div class="flex items-center mt-1">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                  [class]="currentUser.isPublicUser ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'">
              <i [class]="currentUser.isPublicUser ? 'pi pi-user' : 'pi pi-shield'" class="text-xs mr-1"></i>
              {{ userRole() }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Menu Items -->
    <div class="py-1">
      
      <!-- Profile -->
      <button 
        (click)="navigateToProfile()"
        class="w-full flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors duration-150 group">
        <i class="pi pi-user mr-3 text-gray-400 group-hover:text-blue-600 transition-colors duration-150"></i>
        <span class="font-medium">View Profile</span>
      </button>

      <!-- Settings -->
      <button 
        (click)="navigateToSettings()"
        class="w-full flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors duration-150 group">
        <i class="pi pi-cog mr-3 text-gray-400 group-hover:text-blue-600 transition-colors duration-150"></i>
        <span class="font-medium">Settings</span>
      </button>

      <!-- Divider -->
      <div class="border-t border-gray-100 my-1"></div>

      <!-- Admin Dashboard (if admin user) -->
      <a 
        *ngIf="!currentUser.isPublicUser"
        routerLink="/admin/dashboard"
        (click)="closeMenu()"
        class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors duration-150 group">
        <i class="pi pi-th-large mr-3 text-gray-400 group-hover:text-blue-600 transition-colors duration-150"></i>
        <span class="font-medium">Admin Dashboard</span>
      </a>

      <!-- Student Dashboard (if public user) -->
      <a 
        *ngIf="currentUser.isPublicUser"
        routerLink="/public/dashboard"
        (click)="closeMenu()"
        class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors duration-150 group">
        <i class="pi pi-home mr-3 text-gray-400 group-hover:text-blue-600 transition-colors duration-150"></i>
        <span class="font-medium">My Dashboard</span>
      </a>

      <!-- Divider -->
      <div class="border-t border-gray-100 my-1"></div>

      <!-- Help & Support -->
      <button 
        class="w-full flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors duration-150 group">
        <i class="pi pi-question-circle mr-3 text-gray-400 group-hover:text-blue-600 transition-colors duration-150"></i>
        <span class="font-medium">Help & Support</span>
      </button>

      <!-- Logout -->
      <button 
        (click)="logout()"
        class="w-full flex items-center px-4 py-3 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition-colors duration-150 group">
        <i class="pi pi-sign-out mr-3 text-red-400 group-hover:text-red-600 transition-colors duration-150"></i>
        <span class="font-medium">Sign Out</span>
      </button>
    </div>
  </div>

  <!-- Mobile backdrop -->
  <div 
    *ngIf="isMenuOpen()" 
    class="fixed inset-0 z-40 bg-black bg-opacity-25 sm:hidden"
    (click)="closeMenu()">
  </div>
</div>